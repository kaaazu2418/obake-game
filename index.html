<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ãŠã°ã‘ã‚­ãƒ£ãƒƒãƒé¢¨ã‚¿ã‚¤ãƒ ã‚¢ã‚¿ãƒƒã‚¯</title>

<style>
body{
  margin:0;
  background:#eee;
  font-family:sans-serif;
  text-align:center;
}

#startScreen{
  position:fixed;
  inset:0;
  background:#222;
  color:white;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  z-index:10;
}

#startScreen button{
  font-size:28px;
  padding:15px 30px;
  margin-top:20px;
}

#board{
  border:4px solid black;
  display:flex;
  justify-content:center;
  align-items:center;
  background:#ddd;
  padding:10px;
  gap:20px;
  min-height:120px;
}

.cardRow{
  display:flex;
  gap:20px;
}

.scoreBox{
  font-size:24px;
  margin:10px;
}

.items{
  display:flex;
  justify-content:center;
  gap:10px;
  flex-wrap:wrap;
}

button{
  padding:6px;
  background:white;
  border:2px solid #333;
  border-radius:8px;
}

img{
  width:60px;
  height:60px;
  object-fit:contain;
}

.win{
  font-size:30px;
  color:red;
}
</style>
</head>
<body>

<div id="startScreen">
  <h1>ãŠã°ã‘ã‚­ãƒ£ãƒƒãƒé¢¨</h1>
  <p>30ç§’ã§ä½•å•æ­£è§£ã§ãã‚‹ï¼Ÿ</p>
  <button onclick="startGame()">START</button>
</div>

<div class="scoreBox">
  TIME: <span id="timer">30</span> |
  SCORE: <span id="score">0</span>
</div>

<div id="board">
  <div class="cardRow" id="cardArea"></div>
</div>

<div class="items" id="buttons"></div>

<div id="result"></div>

<script>
const items = [
  {name:"apple", color:"red"},
  {name:"dog", color:"brown"},
  {name:"cat", color:"yellow"},
  {name:"hat", color:"black"},
  {name:"car", color:"blue"}
];

const allColors=["red","blue","yellow","brown","black"];

let score=0;
let time=30;
let timerInterval;
let correctItem=null;
let gameActive=false;

const correctSound=new Audio("https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg");

function makeImage(type,color){
  const img=document.createElement("img");
  img.src=`images/${type}_${color}.jpg`;
  return img;
}

function startGame(){
  document.getElementById("startScreen").style.display="none";
  score=0;
  time=30;
  gameActive=true;
  updateDisplay();
  generateCard();
  startTimer();
}

function startTimer(){
  timerInterval=setInterval(()=>{
    time--;
    updateDisplay();
    if(time<=0) endGame();
  },1000);
}

function updateDisplay(){
  document.getElementById("score").innerText=score;
  document.getElementById("timer").innerText=time;
}

/* ===== å®Œå…¨ä¿®æ­£ç‰ˆãƒ­ã‚¸ãƒƒã‚¯ ===== */
function generateCard(){
  if(!gameActive) return;

  const area=document.getElementById("cardArea");
  area.innerHTML="";

  while(true){

    const shuffled=[...items].sort(()=>Math.random()-0.5);
    const pair=[ {...shuffled[0]}, {...shuffled[1]} ];

    pair.forEach(p=>{
      p.displayColor=allColors[Math.floor(Math.random()*5)];
    });

    // å®Œå…¨ä¸€è‡´ã‚’æ•°ãˆã‚‹
    const perfectMatches=pair.filter(p=>{
      return items.some(i=>i.name===p.name && i.color===p.displayColor);
    });

    if(perfectMatches.length === 1){
      correctItem = items.find(i=>i.name===perfectMatches[0].name);

    }else if(perfectMatches.length === 0){

      const usedNames=pair.map(p=>p.name);
      const usedColors=pair.map(p=>p.displayColor);

      const candidates=items.filter(i=>{
        return !usedNames.includes(i.name) &&
               !usedColors.includes(i.color);
      });

      if(candidates.length === 1){
        correctItem=candidates[0];
      }else{
        continue;
      }

    }else{
      // å®Œå…¨ä¸€è‡´ãŒ2ã¤ã‚ã‚‹ â†’ ä½œã‚Šç›´ã—
      continue;
    }

    pair.forEach(p=>{
      area.appendChild(makeImage(p.name,p.displayColor));
    });

    break;
  }
}

function handlePress(item){
  if(!gameActive) return;

  if(item.name===correctItem.name){
    score++;
    correctSound.play();
  }

  updateDisplay();
  generateCard();
}

function endGame(){
  gameActive=false;
  clearInterval(timerInterval);

  saveRanking(score);
  showResult();
}

function saveRanking(newScore){
  let rank=JSON.parse(localStorage.getItem("ranking")||"[]");
  rank.push(newScore);
  rank.sort((a,b)=>b-a);
  rank=rank.slice(0,3);
  localStorage.setItem("ranking",JSON.stringify(rank));
}

function showResult(){
  let rank=JSON.parse(localStorage.getItem("ranking")||"[]");

  let html=`<div class="win">TIME UP!</div>
  <h2>Score: ${score}</h2>
  <h3>ğŸ† Ranking</h3>`;

  rank.forEach((r,i)=>{
    html+=`${i+1}ä½ : ${r}<br>`;
  });

  html+=`<br><button onclick="location.reload()">ã‚‚ã†ä¸€å›</button>`;

  document.getElementById("result").innerHTML=html;
}

function setupButtons(){
  const btnArea=document.getElementById("buttons");

  items.forEach(item=>{
    const b=document.createElement("button");
    b.appendChild(makeImage(item.name,item.color));
    b.onclick=()=>handlePress(item);
    btnArea.appendChild(b);
  });
}

setupButtons();
</script>
</body>
</html>
