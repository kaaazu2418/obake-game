<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>car catch</title>

<style>
body{
  margin:0;
  background:#eee;
  font-family:sans-serif;
  text-align:center;
  overflow:hidden;
}

#startScreen{
  position:fixed;
  inset:0;
  background:#222;
  color:white;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  z-index:10;
}

#board{
  border:4px solid black;
  display:flex;
  justify-content:center;
  align-items:center;
  background:#ddd;
  padding:10px;
  gap:20px;
  min-height:120px;
  position:relative;
}

.cardRow{
  display:flex;
  gap:20px;
}

.scoreBox{
  font-size:24px;
  margin:10px;
}

.items{
  display:flex;
  justify-content:center;
  gap:10px;
  flex-wrap:wrap;
}

button{
  padding:6px;
  background:white;
  border:2px solid #333;
  border-radius:8px;
}

img{
  width:60px;
  height:60px;
  object-fit:contain;
}

.flash{
  position:fixed;
  inset:0;
  background:red;
  opacity:0.4;
  animation:flashAnim 0.25s ease;
  pointer-events:none;
}

@keyframes flashAnim{
  from{opacity:0.6;}
  to{opacity:0;}
}

.sparkle{
  position:fixed;
  inset:0;
  pointer-events:none;
  background:radial-gradient(circle, gold 10%, transparent 10%);
  background-size:50px 50px;
  animation:sparkleAnim 0.6s ease;
}

@keyframes sparkleAnim{
  from{opacity:1;}
  to{opacity:0;}
}
</style>
</head>
<body>

<div id="startScreen">
  <h1>car catch</h1>
  <p>30Áßí„Åß‰ΩïÂïèÊ≠£Ëß£„Åß„Åç„ÇãÔºü</p>
  <button onclick="startGame()">START</button>
</div>

<div class="scoreBox">
  TIME: <span id="timer">30</span> |
  SCORE: <span id="score">0</span>
  <span id="combo" style="margin-left:10px; font-size:18px; color:#ff6600;"></span>
</div>

<div id="board">
  <div class="cardRow">
    <img id="card1">
    <img id="card2">
  </div>
</div>

<div class="items" id="buttons"></div>
<div id="result"></div>

<script>
const items = [
  {name:"apple", color:"red"},
  {name:"dog", color:"brown"},
  {name:"cat", color:"yellow"},
  {name:"hat", color:"black"},
  {name:"car", color:"blue"}
];

const allColors=["red","blue","yellow","brown","black"];

let score=0;
let time=30;
let timerInterval;
let correctItem=null;
let gameActive=false;
let streak=0;

const card1=document.getElementById("card1");
const card2=document.getElementById("card2");


// ==================
// üî• ÁîªÂÉè„Éó„É™„É≠„Éº„Éâ
// ==================
function preloadImages(){
  items.forEach(item=>{
    allColors.forEach(color=>{
      const img=new Image();
      img.src=`images/${item.name}_${color}.jpg`;
    });
  });
}
preloadImages();


// ==================
// üî• WebAudioÈü≥
// ==================
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

function playCorrectSound(){
  const now = audioCtx.currentTime;

  const osc1 = audioCtx.createOscillator();
  const osc2 = audioCtx.createOscillator();
  const gain = audioCtx.createGain();

  osc1.type = "triangle";
  osc2.type = "triangle";

  // „Éù„ÉÉ„Éó„Å™2Èü≥Ôºà„Éî„É≠„É≥‚ô™Ôºâ
  osc1.frequency.setValueAtTime(700, now);
  osc2.frequency.setValueAtTime(1000, now + 0.08);

  gain.gain.setValueAtTime(0.3, now);
  gain.gain.exponentialRampToValueAtTime(0.01, now + 0.25);

  osc1.connect(gain);
  osc2.connect(gain);
  gain.connect(audioCtx.destination);

  osc1.start(now);
  osc1.stop(now + 0.12);

  osc2.start(now + 0.08);
  osc2.stop(now + 0.25);
}

function playMissSound(){
  const osc=audioCtx.createOscillator();
  const gain=audioCtx.createGain();
  osc.type="sawtooth";
  osc.frequency.setValueAtTime(200,audioCtx.currentTime);
  osc.frequency.exponentialRampToValueAtTime(80,audioCtx.currentTime+0.2);
  gain.gain.value=0.3;
  osc.connect(gain);
  gain.connect(audioCtx.destination);
  osc.start();
  osc.stop(audioCtx.currentTime+0.2);
}

function playBonusSound(){
  const osc=audioCtx.createOscillator();
  const gain=audioCtx.createGain();
  osc.type="triangle";
  osc.frequency.setValueAtTime(800,audioCtx.currentTime);
  osc.frequency.linearRampToValueAtTime(1500,audioCtx.currentTime+0.15);
  gain.gain.setValueAtTime(0.3,audioCtx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.01,audioCtx.currentTime+0.3);
  osc.connect(gain);
  gain.connect(audioCtx.destination);
  osc.start();
  osc.stop(audioCtx.currentTime+0.3);
}


// ==================
function startGame(){
  audioCtx.resume(); // „Çπ„Éû„ÉõÂØæÁ≠ñ

  document.getElementById("startScreen").style.display="none";
  score=0;
  time=30;
  streak=0;
  gameActive=true;
  updateDisplay();
  generateCard();
  startTimer();
}

function startTimer(){
  timerInterval=setInterval(()=>{
    time--;
    updateDisplay();
    if(time<=0) endGame();
  },1000);
}

function updateDisplay(){
  document.getElementById("score").innerText=score;
  document.getElementById("timer").innerText=time;

  const comboEl=document.getElementById("combo");

  if(streak>1){
    comboEl.innerText = `${streak} COMBO`;

    if(streak>=5){
      comboEl.style.color="#ff0000";
      comboEl.style.fontWeight="bold";
    }else{
      comboEl.style.color="#ff6600";
      comboEl.style.fontWeight="normal";
    }

  }else{
    comboEl.innerText="";
  }
}

function showFlash(){
  const f=document.createElement("div");
  f.className="flash";
  document.body.appendChild(f);
  setTimeout(()=>f.remove(),250);
}

function showSparkle(){
  const s=document.createElement("div");
  s.className="sparkle";
  document.body.appendChild(s);
  setTimeout(()=>s.remove(),600);
}


// ==================
// üî• DOMÂÜçÁîüÊàê„Åó„Å™„ÅÑÈ´òÈÄüÁâà
// ==================
function generateCard(){
  if(!gameActive) return;

  while(true){

    const shuffled=[...items].sort(()=>Math.random()-0.5);
    const pair=[ {...shuffled[0]}, {...shuffled[1]} ];

    pair.forEach(p=>{
      p.displayColor=allColors[Math.floor(Math.random()*5)];
    });

    const perfectMatches=pair.filter(p=>{
      return items.some(i=>i.name===p.name && i.color===p.displayColor);
    });

    if(perfectMatches.length === 1){
      correctItem = items.find(i=>i.name===perfectMatches[0].name);

    }else if(perfectMatches.length === 0){

      const usedNames=pair.map(p=>p.name);
      const usedColors=pair.map(p=>p.displayColor);

      const candidates=items.filter(i=>{
        return !usedNames.includes(i.name) &&
               !usedColors.includes(i.color);
      });

      if(candidates.length === 1){
        correctItem=candidates[0];
      }else{
        continue;
      }

    }else{
      continue;
    }

    // üî• ÁîªÂÉèÂ∑Æ„ÅóÊõø„Åà„Å†„Åë
    card1.src=`images/${pair[0].name}_${pair[0].displayColor}.jpg`;
    card2.src=`images/${pair[1].name}_${pair[1].displayColor}.jpg`;

    break;
  }
}


function handlePress(item){
  if(!gameActive) return;

  if(item.name===correctItem.name){
    score++;
    streak++;
    playCorrectSound();

    if(streak>=5){
      time+=3;
      playBonusSound();
      showSparkle();
      streak=0;
    }

  }else{
    streak=0;
    playMissSound();
    showFlash();
  }

  updateDisplay();
  generateCard();
}


function endGame(){
  gameActive=false;
  clearInterval(timerInterval);
  document.getElementById("result").innerHTML=
  `<h2>TIME UP!</h2>
   <h3>Score: ${score}</h3>
   <button onclick="location.reload()">„ÇÇ„ÅÜ‰∏ÄÂõû</button>`;
}


function setupButtons(){
  const btnArea=document.getElementById("buttons");

  items.forEach(item=>{
    const b=document.createElement("button");
    const img=document.createElement("img");
    img.src=`images/${item.name}_${item.color}.jpg`;
    b.appendChild(img);
    b.onclick=()=>handlePress(item);
    btnArea.appendChild(b);
  });
}

setupButtons();
</script>
</body>
</html>
